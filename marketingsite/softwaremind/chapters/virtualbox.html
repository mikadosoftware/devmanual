

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>VirtualBox on FreeBSD &#8212; TheDevManual 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/devmanual.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="TheDevManual 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="Adding a new disk" href="usbdisk.html" />
    <link rel="prev" title="Sensible Mail Handling" href="mail-handling.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="virtualbox-on-freebsd">
<h1>VirtualBox on FreeBSD<a class="headerlink" href="#virtualbox-on-freebsd" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Historical note</p>
<p class="last">This never made it into the FreeBSD manual because I was a lazy a** and never
did the re-formating they wanted, but I am still quite proud of it.</p>
</div>
<div class="figure" id="id3">
<img alt="chapters/../img/virtualisation.png" class="screenshot" src="chapters/../img/virtualisation.png" />
<p class="caption"><span class="caption-text">Windows and Ubunutu running inside a FreeBSD Host.</span></p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Virtualisation, running more than one instance of (potentially) more
than one Operating System on a single physical computer, is growing in
popularity and power.</p>
<p>FreeBSD offers two different types of virtualisation, which can be
characterised as single-kernel virtualisation and multiple-kernel
virtualisation.</p>
<p>The first, implemented natively to FreeBSD, is Jails, allowing one
FreeBSD kernel to run many instances of a compatible FreeBSD system.
This approach is simple, and fast and is probably the best choice if
you wish to run several non-GUI instances (ie a mail machine, a web
server and a database).  The author has successfully used this
approach for some years commercially and at home.  However if the
author wished to run Windows or any other operating system on the Jail
Host it would not work - every instance in a Jail uses the same
kernel, so not even different versions of FreeBSD will run on a jail.
In order to run different operating systems one turns to multi-kernel
virtualisation.</p>
<p>This second approach, often called &#8220;true&#8221; virtualisation, (but usually
only by the vendors of this class of software), is where a Virtual
Machine Manager (VMM) is created that acts as a &#8220;interpretation layer&#8221;
between the Host OS (in our case FreeBSD) and the Guest OS (for
example a Windows XP instance).</p>
<p>VirtualBox, currently owned by Oracle, is a dual-licensed VMM, with a
commercial version and and OSE (Open Source Edition).  This Open
Source Edition has been ported natively to FreeBSD, and this chapter
shall demonstrate the steps necessary to successful implementation.</p>
<p>It is worth noting that VirtualBox OSE has been intentionally crippled
- it will not pass through RDP requests (you cannot &#8220;remote desktop&#8221;
into the box) and it will not allow USB devices plugged into the Host
OS to be accessible to the Guest OS.  The commerical version does
allow these functions.</p>
<div class="section" id="hardware-support">
<h3>Hardware support<a class="headerlink" href="#hardware-support" title="Permalink to this headline">¶</a></h3>
<p>Until recently virtualised machines were noticeably slow - because the
&#8220;interpretation layer&#8221; was implemented solely in software.  However as
virtualisation has grown in popularity, the major chip vendors have
worked to develop hardware extensions to improve speed.</p>
<p>There have been two major innovations in hardware-based
virtualisation.  VMX extensions and nested paging.  The first has been
around for a couple of years, and in essence performs the marking of
each process in the host as belonging to the correct Guest OS.</p>
<p>The second is most recent, found in the Nehalem-range on Intel CPUs
and their AMD competitor (?)- without this, a VM must pretend it holds
a paging cache - so any cache misses end up being processed twice,
once in the &#8220;real&#8221; cache, once in the VM version.</p>
<p>Anecdotally, a CPU without VMX flags and Nehalem, can be around 3-5
times slower in virtualisation, and for a desktop machine this is very
noticeable.</p>
<p>You can detect if your CPU supports the VMX extensions by looking at
dmesg for CPU flags, notable VMX and SSE flags</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CPU</span><span class="p">:</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Core</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">i7</span> <span class="n">CPU</span>       <span class="n">M</span> <span class="mi">620</span>  <span class="o">@</span> <span class="mf">2.67</span><span class="n">GHz</span> <span class="p">(</span><span class="mf">2660.02</span><span class="o">-</span><span class="n">MHz</span> <span class="mi">686</span><span class="o">-</span><span class="k">class</span> <span class="nc">CPU</span><span class="p">)</span> <span class="n">Origin</span> <span class="o">=</span> <span class="s2">&quot;GenuineIntel&quot;</span>  <span class="n">Id</span> <span class="o">=</span> <span class="mh">0x20652</span>  <span class="n">Family</span> <span class="o">=</span> <span class="mi">6</span>  <span class="n">Model</span> <span class="o">=</span> <span class="mi">25</span>  <span class="n">Stepping</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">Features2</span><span class="o">=</span><span class="mh">0x298e3ff</span><span class="o">&lt;</span><span class="n">SSE3</span><span class="p">,</span><span class="n">PCLMULQDQ</span><span class="p">,</span><span class="n">DTES64</span><span class="p">,</span><span class="n">MON</span><span class="p">,</span><span class="n">DS_CPL</span><span class="p">,</span><span class="n">VMX</span><span class="p">,</span><span class="n">SMX</span><span class="p">,</span><span class="n">EST</span><span class="p">,</span><span class="n">TM2</span><span class="p">,</span><span class="n">SSSE3</span><span class="p">,</span>
                                                       <span class="o">^^^</span>
                      <span class="n">CX16</span><span class="p">,</span><span class="n">xTPR</span><span class="p">,</span><span class="n">PDCM</span><span class="p">,</span><span class="n">SSE4</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="n">SSE4</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="n">POPCNT</span><span class="p">,</span><span class="n">AESNI</span><span class="o">&gt;</span>
                                     <span class="o">^^^^^^^^^^^^^</span>
</pre></div>
</div>
<p>VMX (almost certainly a requirement for decent Desktop vitualisation)
and SSE4 extensions are shown above.</p>
</div>
<div class="section" id="prerequisities">
<h3>Prerequisities<a class="headerlink" href="#prerequisities" title="Permalink to this headline">¶</a></h3>
<p>You will need a properly configured X-Windows installation (see
Handbook) and sufficient RAM and Hard Disk space.  For each
desktop-style Guest OS you would expect to need between 256-384MB of
RAM and 6+GB of space, and the more especially of RAM the better the
experience.</p>
</div>
<div class="section" id="installing-virtualbox">
<h3>Installing VirtualBox<a class="headerlink" href="#installing-virtualbox" title="Permalink to this headline">¶</a></h3>
<p>NB. These instructions deal with port at or after OSE 3.1.2/</p>
<p>To build VirtualBox use the port found at</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">ports</span><span class="o">/</span><span class="n">emulators</span><span class="o">/</span><span class="n">virtualbox</span><span class="p">;</span> <span class="n">make</span> <span class="n">install</span> <span class="n">clean</span>
</pre></div>
</div>
<p>You are <em>strongly</em> recommended to select the GuestAdditions option
when configuring the port.  This will install the port
virtualbox-ose-additions, an .iso of dirvers and other useful
features.  If you find Windows is unable to exceed 800x600 then Guest
additions is not installed.</p>
<p>This port has been rewritten recently to make VirtualBox install
simpler and easier.  Once you have compiled it, you will need to
adjust /boot/loader.conf as below</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">vboxdrv_load</span><span class="o">=</span><span class="s2">&quot;YES&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">loader</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>If you enter &#8220;VirtualBox&#8221; from a terminal you should see a start up screen like this:</p>
<div class="figure">
<img alt="chapters/../img/vbox_intro.png" class="screenshot" src="chapters/../img/vbox_intro.png" />
</div>
</div>
<div class="section" id="preparing-for-first-guest-os">
<h3>Preparing for first Guest OS<a class="headerlink" href="#preparing-for-first-guest-os" title="Permalink to this headline">¶</a></h3>
<p>The principle behind the setup is simple.  Allocate a certain amount
of your harddisk to become a single file.  That single file will
pretend to be a real Hard Disk to the VM, which will also have access
to all your peripherals, network card and a pre-determined slice of
RAM.</p>
<p>The VMM has a simple to use wizard and it is recommended to use this
for the first VM.  You will need to experiment a little on the optimum
Hard disk and RAM allocation for your machine, but 384MB and 8GB has
been found to be a workable minimum for Windows XP and ubuntu
installs.</p>
<p>After the wizard has run you should now have a &#8220;virtual machine&#8221; ready
to start - 8GB of Harddrive (actually a single file on your real
harddrive) and 384MB of RAM ready to go.  At this point we can boot up
the instance, and you should see a complaint that there is no bootable
image.  We shall now install a OS onto the vitual machine.</p>
<div class="figure">
<img alt="chapters/../img/vbox_ready.png" class="screenshot" src="chapters/../img/vbox_ready.png" />
</div>
</div>
<div class="section" id="setting-up-first-guest-os">
<h3>Setting up first Guest OS<a class="headerlink" href="#setting-up-first-guest-os" title="Permalink to this headline">¶</a></h3>
<p>We want the VM to boot up, and then look for a bootable image (ie the
VM boots and is given a install CD).  This can be done in two ways -
by allowing the VM access to our own CD/DVD drive, or by mounting an
ISO for it.  THe second is a lot more convenient - especially for
ubuntu.</p>
<div class="section" id="obtain-iso">
<h4>Obtain ISO<a class="headerlink" href="#obtain-iso" title="Permalink to this headline">¶</a></h4>
<p>You can just download the latest Ubuntu ISO, or you can extract your
<em>licensed</em> copy of XP by placing the CD in your CD drive and</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># dd if=/dev/acd0 of=/home/pbrian/downloads/xp.iso bs=2048</span>
</pre></div>
</div>
<p>(NB the block size setting is <em>very</em> important - without it you will not
copy anything from a CD drive)</p>
<p>Now visit the CD tab in the VMM GUI.  tick the &#8216;Mount CD Drive&#8217; and
then tick &#8216;Mount from ISO&#8217;.  Simply find the iso image on your HDD,
and now the Virtual Machine you selected will be able to &#8220;see&#8221; the CD
as if it was in a normal CD drive.</p>
</div>
<div class="section" id="install-from-iso">
<h4>Install From ISO<a class="headerlink" href="#install-from-iso" title="Permalink to this headline">¶</a></h4>
<p>Start up the VM instance, now you will be able to install the chosen
OS as you would expect, perhaps a little faster than you are used to.</p>
<p>After installing your chosen OS, you will be able to &#8220;start&#8221; the VM
from the VMM control panel - do so now, and you will see the usual
boot up screens and then a working instance of another Operating
System in your FreeBSD machine.</p>
</div>
</div>
<div class="section" id="networking">
<h3>Networking<a class="headerlink" href="#networking" title="Permalink to this headline">¶</a></h3>
<p>VirtualBox offers a NAT-based networking address for your VM out-of-the-box.
This enables you to initiate connections from the VM, but to have connections
initiated <em>to</em> the VM, you will need to set up &#8220;Ethernet Bridging&#8221;.</p>
<div class="section" id="bridged-networking">
<h4>Bridged Networking<a class="headerlink" href="#bridged-networking" title="Permalink to this headline">¶</a></h4>
<p>Netgraph is one such popular way of setting up Bridged Networking,
creating a driver that is able to bypass the usual networking stack.</p>
<p>With this the VM can take a packet off the real NIC, read it
and then put its own reply back onto the real NIC at the same layer -
it looks to the Host OS as if right next door on the Ethernet network is
another NIC reading the packets it reads and putting more on the
network.</p>
<p>The Virtual machine on the other hand just sets up its stack as
normal, thinking it has access to a genuine real NIC.</p>
<p>Its a bit like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Host</span>  <span class="n">VM</span>
 \    <span class="o">/</span>
  \  <span class="o">/</span>
   <span class="o">--</span>  <span class="n">Netgraph</span>
   <span class="o">|</span>
   <span class="n">NIC</span>
</pre></div>
</div>
<p>You will need to re-compile your kernel (see Handbook for instructions).
The following can be used as a kernel configuration file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="n">GENERIC</span>
<span class="n">ident</span> <span class="n">NGRAPH</span>

<span class="n">options</span> <span class="n">NETGRAPH</span>
</pre></div>
</div>
<p>You will then need to switch the current virtual NIC over to Bridged mode
in the VMM GUI and select the appropriate driver - PCNet III works well the
Netgraph driver.</p>
</div>
</div>
<div class="section" id="bibliography">
<h3>bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">help</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">community</span><span class="o">/</span><span class="n">Installation</span><span class="o">/</span><span class="n">QemuEmulator</span>
<span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">help</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">community</span><span class="o">/</span><span class="n">WindowsXPUnderQemuHowTo</span>
<span class="o">-</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">wiki</span><span class="o">.</span><span class="n">freebsd</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">qemu</span>
<span class="o">-</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dryice</span><span class="o">.</span><span class="n">name</span><span class="o">/</span><span class="n">blog</span><span class="o">/</span><span class="n">freebsd</span><span class="o">/</span><span class="n">using</span><span class="o">-</span><span class="n">freebsd</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">bridge</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">dummynet</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">shape</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">traffic</span><span class="o">/</span>
<span class="o">-</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">freebsd</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">books</span><span class="o">/</span><span class="n">handbook</span><span class="o">/</span><span class="n">network</span><span class="o">-</span><span class="n">bridging</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>Bibliography<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">freebsd</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">en_US</span><span class="o">.</span><span class="n">ISO8859</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">books</span><span class="o">/</span><span class="n">handbook</span><span class="o">/</span><span class="n">virtualization</span><span class="o">-</span><span class="n">host</span><span class="o">.</span><span class="n">html</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">wiki</span><span class="o">.</span><span class="n">freebsd</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">VirtualBox</span>
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>Well, attitudes to this might be changing.  ARM-based blade servers can actually deliver more CPU cycles per Watt, actually being more green, but other issues start to dominate, ranging from deciding if your work is IO bound or CPU bound, or handling the logistics required.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Paul Brian.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>