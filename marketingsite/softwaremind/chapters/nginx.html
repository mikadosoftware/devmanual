

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nginx - load balancing &#8212; TheDevManual 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/devmanual.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="TheDevManual 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="Setting up python repos to use Sphinx and Github Pages" href="gh-pages.html" />
    <link rel="prev" title="emacs" href="emacs.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="nginx-load-balancing">
<h1>Nginx - load balancing<a class="headerlink" href="#nginx-load-balancing" title="Permalink to this headline">¶</a></h1>
<p>Almost out of nowehre in 2007/8 nginx came on the scene and started to
beat out the competition of the Open Apache and the closed Zeus.</p>
<p>It is now pretty much the defacto web server going, easy to install,
simple(r) to configure and fast, fast, fast.</p>
<p>Heres a look at how nginx does basic load balancing</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">upstream</span>  <span class="n">yoursite</span>  <span class="p">{</span>
   <span class="n">server</span>   <span class="n">yoursite1</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite2</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">server</span> <span class="p">{</span>
   <span class="n">server_name</span> <span class="n">www</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
   <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
      <span class="n">proxy_pass</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">yoursite</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This configuration will send 50% of the requests for www.yoursite.com to
yoursite1.yoursite.com and the other 50% to yoursite2.yoursite.com.  ip_hash</p>
<p>You can specify the ip_hash directive that guarantees the client request will
always be transferred to the same server.  If this server is considered
inoperative, then the request of this client will be transferred to another
server.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">upstream</span>  <span class="n">yoursite</span>  <span class="p">{</span>
   <span class="n">ip_hash</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite1</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite2</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="down">
<h2>Down<a class="headerlink" href="#down" title="Permalink to this headline">¶</a></h2>
<p>If one of the servers must be removed for some time, you must mark that server
as down.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">upstream</span>  <span class="n">yoursite</span>  <span class="p">{</span>
   <span class="n">ip_hash</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite1</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span> <span class="n">down</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite2</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="weight">
<h2>weight<a class="headerlink" href="#weight" title="Permalink to this headline">¶</a></h2>
<p>If you add a weight tag onto the end of the server definition you can modify the
percentages of the requests send to the servers.  When there?s no weight set,
the weight is equal to one.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">upstream</span>  <span class="n">yoursite</span>  <span class="p">{</span>
   <span class="n">server</span>   <span class="n">yoursite1</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span> <span class="n">weight</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite2</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This configuration will send 80% of the requests to yoursite1.yoursite.com and
the other 20% to yoursite2.yoursite.com.</p>
<p>note: It?s not possible to combine ip_hash and weight directives.  max_fails and
fail_timeout</p>
<p>max_fails is a directive defining the number of unsuccessful attempts in the
time period defined by fail_timeout before the server is considered
inoperative. If not set, the number of attempts is one. A value of 0 turns off
this check.  If fail_timeout is not set the time is 10 seconds.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">upstream</span>  <span class="n">yoursite</span>  <span class="p">{</span>
   <span class="n">server</span>   <span class="n">yoursite1</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
   <span class="n">server</span>   <span class="n">yoursite2</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span> <span class="n">max_fails</span><span class="o">=</span><span class="mi">3</span>  <span class="n">fail_timeout</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this configuration nginx will consider yoursite2.yoursite.com as inoperative
if a request fails 3 times with a 30s timeout.  backup</p>
<p>If the non-backup servers are all down or busy, the server(s) with the backup
directive will be used.</p>
<blockquote>
<div><dl class="docutils">
<dt>upstream  yoursite  {</dt>
<dd>server   yoursite1.yoursite.com max_fails=3;
server   yoursite2.yoursite.com max_fails=3;
server   yoursite3.yoursite.com backup;</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>This configuration will send 50% of the requests for www.yoursite.com to
yoursite1.yoursite.com and the other 50% to yoursite2.yoursite.com.  If
yoursite1.yoursite.com and yoursite2.yoursite.com both fails 3 times the
requests will be send to yoursite3.yoursite.com.</p>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Paul Brian.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>