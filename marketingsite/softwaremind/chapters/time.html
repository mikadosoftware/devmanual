

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Time &#8212; TheDevManual 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/devmanual.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="TheDevManual 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="&lt;no title&gt;" href="software-capital.html" />
    <link rel="prev" title="Time and Docker" href="time_in_docker.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="time">
<h1>Time<a class="headerlink" href="#time" title="Permalink to this headline">¶</a></h1>
<div class="section" id="time-waits-for-no-man">
<h2>Time waits for no man<a class="headerlink" href="#time-waits-for-no-man" title="Permalink to this headline">¶</a></h2>
<p>Or it flies like an arrow. Something like that. But still keeping accurate time
is as important now as it was when <a class="reference external" href="http://en.wikipedia.org/wiki/John_Harrison">Harrison</a> built his first clock.  In a
networked world, having one machine with accurate time is not the worst
problem - all the machines we use need to be synchronised to the same time, else
trying to compare logs on different machines is quite simply a nightmare.</p>
<p>The solution to both these problems is called Network Time Protocol or NTP. NTP
is a way for any server to get the current time from an atomic clock, even if it
is thousands of miles away.  Atomic clocks keep, what is simply the most
accurate time humankind can keep.  These clocks then are used to keep <em>stratum
1</em> servers up to date. These stratum 1 servers are the starting point for NTP,
and are primarily run by academic and governmental institutions.  They are the
source point for, rather boringly, <em>stratum 2</em> servers. These stratum 2 servers
are run, often by volunteers to provide you and I with a machine that knows
precisely what the time is, and more importantly, are willing to tell us.</p>
<p>Whilst the servers themselves are run in wildly different locations, and by
different organisations, a sensible DNS round-robin is in place.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Name</span><span class="p">:</span>   <span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>
<span class="n">Address</span><span class="p">:</span> <span class="mf">64.202</span><span class="o">.</span><span class="mf">112.75</span> <span class="p">(</span><span class="n">ntp</span><span class="o">.</span><span class="n">your</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="p">)</span>

<span class="n">Name</span><span class="p">:</span>   <span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>
<span class="n">Address</span><span class="p">:</span> <span class="mf">38.99</span><span class="o">.</span><span class="mf">80.156</span> <span class="p">(</span><span class="n">clock</span><span class="o">.</span><span class="n">fihn</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>
<p>Here two servers run by totally different organisations are pulled up when I ask
for pool.ntp.org. So all I need to remember is one dns name and my ntp requests
will alwasy find a suitable match. This is good news for me, but also very good
news for Poul Henning Kemp <a class="footnote-reference" href="#id2" id="id1">[1]</a></p>
<p>Anyway, NTP works in a clever and comlicated way, but the Simple IT manager can
get by with a good enough explanation, and a reference for more info.  The good
enough explanation is that the NTP client asks for a time check and waits for
the answer to come back several times. With enough times and a clever algorithm,
the latency in the network can be estimated and that latency can be added to the
time in the received message to give an accurate time <em>right now</em>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">NTPv4</span> <span class="n">can</span> <span class="n">usually</span> <span class="n">maintain</span> <span class="n">time</span> <span class="n">to</span> <span class="n">within</span> <span class="mi">10</span> <span class="n">milliseconds</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">100</span> <span class="n">s</span><span class="p">)</span> <span class="n">over</span> <span class="n">the</span>
<span class="n">public</span> <span class="n">Internet</span><span class="p">,</span> <span class="ow">and</span> <span class="n">can</span> <span class="n">achieve</span> <span class="n">accuracies</span> <span class="n">of</span> <span class="mi">200</span> <span class="n">microseconds</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">5000</span> <span class="n">s</span><span class="p">)</span> <span class="ow">or</span>
<span class="n">better</span> <span class="ow">in</span> <span class="n">local</span> <span class="n">area</span> <span class="n">networks</span> <span class="n">under</span> <span class="n">ideal</span> <span class="n">conditions</span><span class="o">.</span>

<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">en</span><span class="o">.</span><span class="n">wikipedia</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="n">Network_Time_Protocol</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-get-the-time-right-on-your-server">
<h2>How to get the time right on your server<a class="headerlink" href="#how-to-get-the-time-right-on-your-server" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Set your current timezone</li>
<li>set the time correctly from an atomic clock</li>
<li>keep on adjusting it</li>
</ol>
<div class="section" id="set-your-current-timezone">
<h3>1. Set your current timezone<a class="headerlink" href="#set-your-current-timezone" title="Permalink to this headline">¶</a></h3>
<p>In /usr/share/zoneinfo are a series of binary files that represent to the server how to calculate the timezone - so /usr/share/zoneinfo/Europe/London tells us how to adjust for the GMT zone.
We want to copy the one that is right for our location in to /etc/localtime</p>
<blockquote>
<div>diff /etc/localtime /usr/share/zoneinfo/Europe/London</div></blockquote>
<p>(there may not be a /etc/localtime file. In fact if this is the first install, there wont be)</p>
<p>So let us have some fun:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">manhattan</span><span class="c1"># cp /usr/share/zoneinfo/Asia/Tokyo  /etc/localtime</span>
<span class="n">manhattan</span><span class="c1"># adjkerntz -a</span>
<span class="n">manhattan</span><span class="c1"># date</span>
<span class="n">Sat</span> <span class="n">Aug</span> <span class="mi">16</span> <span class="mi">20</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">02</span> <span class="n">JST</span> <span class="mi">2008</span>
<span class="n">manhattan</span><span class="c1">#</span>
<span class="n">manhattan</span><span class="c1">#</span>
<span class="n">manhattan</span><span class="c1"># cp /usr/share/zoneinfo/Europe/London /etc/localtime</span>
<span class="n">manhattan</span><span class="c1"># adjkerntz -a</span>
<span class="n">manhattan</span><span class="c1"># date</span>
<span class="n">Sat</span> <span class="n">Aug</span> <span class="mi">16</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">23</span> <span class="n">BST</span> <span class="mi">2008</span>
</pre></div>
</div>
</div>
<div class="section" id="clock-synchronisation">
<h3>2. clock synchronisation<a class="headerlink" href="#clock-synchronisation" title="Permalink to this headline">¶</a></h3>
<p>Ok, we can control what timezone the machine thinks it is in, but how do we get the time correct?
The configuration file for ntp daemon is /etc/ntpd.conf</p>
<p>put this minimal file into /etc/ntpd.conf:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">driftfile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">ntp</span><span class="o">.</span><span class="n">drift</span>
<span class="n">server</span> <span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>
<span class="n">restrict</span> <span class="n">default</span> <span class="n">ignore</span>  <span class="c1">#stops this machine being used by anyone else for ntp</span>

<span class="c1">##also</span>
<span class="n">touch</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">db</span><span class="o">/</span><span class="n">ntp</span><span class="o">.</span><span class="n">drift</span>
</pre></div>
</div>
<p>(NB there is a diff between the location in freebsd handook and the ntp ssite for conf file
ntpd.conf vs ntp.conf. ntp.conf is right - follow the handbook)</p>
<p>This tells the server to use a drift file, which is how ntpd calculates the average latency for its requests, and
which servers it should contact - if you wanted a really minimalist conf file, the last line will suffice.</p>
<p>Enable the server at boot time:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ntpd_enable</span><span class="o">=</span><span class="s2">&quot;YES&quot;</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>TO force the server to change to a new time, especially if the time is a long way out, then we can use</p>
<blockquote>
<div>ntpdate pool.ntp.org</div></blockquote>
<p>ntpdate forces a time update no matter how far out the server is - this is useful, but you should rely on ntpd to correct the time
- if it finds itself correcting large leaps it will scream to the logs. This is good - there are only two reasons for regular large corrections, either your motherboards clock is dying or you have invented time travel.</p>
<p>Sample rc.conf file with a full time set on boot:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ntpdate_enable</span><span class="o">=</span><span class="s2">&quot;YES&quot;</span>
<span class="n">ntpdate_flags</span><span class="o">=</span><span class="s2">&quot;pool.ntp.org&quot;</span>
<span class="c1">#enable ntpd after ntpdate - ntpdate does nothing if  ntpd is running.</span>
<span class="n">ntpd_enable</span><span class="o">=</span><span class="s2">&quot;YES&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="trouble-shooting">
<h3>Trouble shooting<a class="headerlink" href="#trouble-shooting" title="Permalink to this headline">¶</a></h3>
<p>I often get tripped up by this when running ntpdate manually:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s2">&quot;step-systime: Operation not permitted&quot;</span>
</pre></div>
</div>
<p>It is a permissions problem, but crops up most often in Jails and
related virtualised servers.  The access to the hardware layer is
mediated and so even as root on a Jail, you cannot set time - time is
fixed on the host OS.</p>
</div>
<div class="section" id="update">
<h3>2018 Update<a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h3>
<p>So on systems with systemd (which despite the controversy is most of them)
there is now <cite>timedatectl</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">timedatectl</span>

<span class="n">timedatectl</span> <span class="nb">list</span><span class="o">-</span><span class="n">timezones</span>

<span class="n">timedatectl</span> <span class="nb">set</span><span class="o">-</span><span class="n">timezone</span> <span class="n">Europe</span><span class="o">/</span><span class="n">London</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Poul-Henning Kemp is a respected FreeBSD developer who ran a Stratum 1 Server. His server was referenced by a commercial domestic router sold in its millions, and by IP address. He was getting 3 million packets a day extra.  Full story is at <a class="reference external" href="http://www.lightbluetouchpaper.org/2006/04/07/when-firmware-attacks-ddos-by-d-link/">http://www.lightbluetouchpaper.org/2006/04/07/when-firmware-attacks-ddos-by-d-link/</a></td></tr>
</tbody>
</table>
<div class="section" id="bibliography">
<h3>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://www.freebsd.org/doc/en/books/handbook/network-ntp.html">http://www.freebsd.org/doc/en/books/handbook/network-ntp.html</a>
<a class="reference external" href="http://support.ntp.org/bin/view/Servers/NTPPoolServers">http://support.ntp.org/bin/view/Servers/NTPPoolServers</a></p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Paul Brian.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>