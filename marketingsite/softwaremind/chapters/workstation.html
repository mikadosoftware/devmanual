

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Building a FreeBSD laptop from scratch with Salt-stack &#8212; TheDevManual 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/devmanual.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="TheDevManual 0.0.1 documentation" href="../index.html" />
    <link rel="next" title="Modern(ish) Web Development" href="webdev.html" />
    <link rel="prev" title="Workstation" href="workstation-install.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="building-a-freebsd-laptop-from-scratch-with-salt-stack">
<h1>Building a FreeBSD laptop from scratch with Salt-stack<a class="headerlink" href="#building-a-freebsd-laptop-from-scratch-with-salt-stack" title="Permalink to this headline">¶</a></h1>
<div class="section" id="workstation">
<h2>Workstation<a class="headerlink" href="#workstation" title="Permalink to this headline">¶</a></h2>
<p>Workstation builds also matter, but my preference now is local docker</p>
<p>So this chapter changed a lot...</p>
<p>I am a big FreeBSD user, both in servers and as a personal workstation.  Yes,
Linux is <em>easier</em> as a workstation, but then so is Windows.  And its nice to
have the same environments.</p>
<p>I however often find myself putting off important upgrades because my laptop
is my working life - losing a day here would cost real money.  I need to
automate the maintenance of my laptop.  And Shell scripts don&#8217;t seem &#8220;official&#8221;
enough.  (I may occassionally cheat however :)</p>
<p>So as well as <a class="reference external" href="http://pyholodeck.mikadosoftware.com">installing servers using salt-stack</a> here is how to build a set of
DevOps quality scripts to keep your workstation rebuildable at a moments notice,
and keep the day-to-day maintenance spruced up and ship shape!</p>
<p>The idea is to install the laptop with FreeBSD 10,
point it at the new packaging system, run the miniuon bootstrap,
download my own set of salt states, and ... presto.</p>
<div class="section" id="starting-off">
<h3>Starting off<a class="headerlink" href="#starting-off" title="Permalink to this headline">¶</a></h3>
<p>Firstly I need to wipe and install a FreeBSD minimum image onto a machine.
Luckily this is easy - just download the latest <cite>.img</cite> file from FreeBSD.org,
and copy it over to a USB.</p>
<p>Visit:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ftp</span><span class="p">:</span><span class="o">//</span><span class="n">ftp</span><span class="o">.</span><span class="n">freebsd</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">FreeBSD</span><span class="o">/</span><span class="n">snapshots</span><span class="o">/</span><span class="n">ISO</span><span class="o">-</span><span class="n">IMAGES</span><span class="o">/</span><span class="mf">10.0</span><span class="o">/</span>
</pre></div>
</div>
<p>and pull back the latest <cite>*memstick.img</cite> file such as</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">FreeBSD</span><span class="o">-</span><span class="mf">10.0</span><span class="o">-</span><span class="n">STABLE</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="mi">20140421</span><span class="o">-</span><span class="n">r264704</span><span class="o">-</span><span class="n">memstick</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>Now we <cite>dd</cite> over the image from disk to USB.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ dd if=memstick.img of=/dev/da0 bs=1024 conv=sync
</pre></div>
</div>
<p>Reboot the laptop with USB key attached (ensuring of course the BIOS is set to
boot from USB <em>before</em> HDD).</p>
<p>Now install FreeBSD as usual.  It is a pretty straightforward install, and well
documented in the <a class="reference external" href="http://www.freebsd.org/doc/handbook/install-start.html">FreeBSD Manual</a>.</p>
<div class="section" id="download-and-run-bootstrap-installer">
<h4>Download and run bootstrap installer<a class="headerlink" href="#download-and-run-bootstrap-installer" title="Permalink to this headline">¶</a></h4>
<p>The salt stack bootstrap script essentially downloads salt onto your local
machine (OK, a number of potential issues there), and will do various OS
specific setups (in FreeBSD&#8217;s case, prepare the <cite>pkg</cite> environment, point at the
right URLs etc.)</p>
<p>Unfortunately fetch is a bit rubbish compared to wget, and barfs on SSL
certificates like the dodgy ones at github.  I should look into it.</p>
<blockquote>
<div><p>$ setenv SSL_NO_VERIFY_PEER 1
$ fetch <a class="reference external" href="http://bootstrap.saltstack.org">http://bootstrap.saltstack.org</a></p>
<p>This seems a very bad idea, as we are opening up to a MITM attack.
I would prefer either:
* md5 signing
* download wget <em>first</em>
<a class="reference external" href="https://github.com/saltstack/salt-bootstrap/issues/290">https://github.com/saltstack/salt-bootstrap/issues/290</a></p>
</div></blockquote>
<p>This will migrate me to using the <cite>pkgng</cite> (FreeBSD&#8217;s own apt-get setup)
convert the laptop to a minion, and then all I need to do is set the
right values in /env/salt and call local highstate</p>
<ol class="arabic simple">
<li>Download the appropriate salt-states</li>
<li>apply to /usr/local/etc/salt</li>
<li>run  <cite>salt-call &#8211;local state.highstate</cite></li>
</ol>
<p>This way I have now applied a set of states I want on the laptop to a local
cache location (for these
purposes, just Xorg).  They include config files etc.</p>
</div>
</div>
</div>
<div class="section" id="changes">
<h2>Changes<a class="headerlink" href="#changes" title="Permalink to this headline">¶</a></h2>
<p>We want to put the states in /usr/local/etc/salt/states
We want to put our own execution modules in /usr/local/etc/salt/states
<em>and</em> alter /usr/local/etc/salt/minion to change its <cite>module_dirs []</cite> list
to include that.</p>
<div class="section" id="how-does-salt-call-work-brief">
<h3>How does salt-call work (brief)?<a class="headerlink" href="#how-does-salt-call-work-brief" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Process the base environment top.sls file.  This is by default
<cite>/srv/salt/top.sls</cite> but can be changed (see file_roots)</li>
<li></li>
</ol>
</div>
<div class="section" id="what-do-i-actually-want-on-my-workstation">
<h3>What do I actually want on my workstation?<a class="headerlink" href="#what-do-i-actually-want-on-my-workstation" title="Permalink to this headline">¶</a></h3>
<p>An article per pkg, ala NTP plus the init.sls and assoc state files.</p>
<ul class="simple">
<li>sudo</li>
<li>wget</li>
<li>xfce4
hal
dbus
xorg
randr and multi head</li>
<li>urxvt / xterm for unicode
<a class="reference external" href="http://www.cl.cam.ac.uk/~mgk25/unicode.html">http://www.cl.cam.ac.uk/~mgk25/unicode.html</a>
<a class="reference external" href="https://wiki.archlinux.org/index.php/fonts">https://wiki.archlinux.org/index.php/fonts</a>
$ setfont Lat2-Terminus16</li>
<li>aspell</li>
<li>bash</li>
<li>bsdstats</li>
<li>security
port scanner
gnupg
keychain
ssh</li>
<li>sysadmin
jails</li>
<li>dbases
sqlite
postgres</li>
<li>webkit</li>
<li>sound</li>
<li>video</li>
<li>curl</li>
<li>wget</li>
<li>emacs</li>
<li>git / git gui</li>
<li>sublime?</li>
<li>fonts</li>
<li>printing</li>
<li>Firewall</li>
<li>python eco-system</li>
<li>ZFS (TBD)</li>
<li>web browsers</li>
<li></li>
<li>ImageMagick</li>
<li>gimp</li>
<li>rabbitMQ</li>
<li>spreadsheets??</li>
</ul>
</div>
<div class="section" id="other-needs">
<h3>Other needs<a class="headerlink" href="#other-needs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>RPi Routers and NetFlow / packetburst for my local office network</li>
</ul>
</div>
<div class="section" id="business-half">
<h3>Business Half<a class="headerlink" href="#business-half" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Reporting and Dotted Co-ordination Framework</li>
</ul>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Paul Brian.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>